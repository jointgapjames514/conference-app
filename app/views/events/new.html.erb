<!-- <script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script> -->

<div class="form-group"><h1>Create New Event Group</h1></div>

<%= form_for :event, url: events_path, :html => { :id => "new_event_form" }  do |f| %>
  <div class="form-group">
	<p>Fields with <span class="asteroid">*</span> are required.</p>
  </div>

  <div class="form-group row">
	<label for="name" class="col-xs-3 col-form-label">Event Name <span class="asteroid">*</span></label>
	<div class="col-xs-6">
	  <%= f.text_field :name, :class => 'form-control' %>
	</div>
  </div>

  <div class="form-group row">
	<label for="description" class="col-xs-3 col-form-label">Description <span class="asteroid">*</span></label>
	<div class="col-xs-6">
	  <%= f.text_area :description, :class => 'form-control', :rows => 7 %>
	</div>
  </div>

  <div class="form-group row">
	<label for="category_id" class="col-xs-3 col-form-label">Category</label>
	<div class="col-xs-3">
	  <% if @category_types %>
	  <%= f.select :category_id, options_for_select(@category_types.map{ |c| [c.category, c.id] }), {}, {:class => 'form-control'} %>
	  <% else %>
	  <span>Category does not exist.</span>>
	  <% end %>
	</div>
  </div>

  <div class="form-group row">
	<label for="avatar" class="col-xs-3 col-form-label">Event Logo</label>
	<div class="col-xs-6">
      <%= f.file_field :avatar %>
      <%= f.hidden_field :avatar_cache %>
	</div>
  </div>

  <div class="form-group row">
	<label for="timezone" class="col-xs-3 col-form-label">Timezone</label>
	<div class="col-xs-3">
	  <select name="event[timezone]" id="event_timezone" class="form-control"></select>
	</div>
  </div>

  <div class="form-group row">
	<label for="start_date" class="col-xs-3 col-form-label">Start Date <span class="asteroid">*</span></label>
	<div class="col-xs-3">
	<%= f.text_field :start_date, :readonly => true, :class => 'form-control' %>
	</div>
  </div>

  <div class="form-group row">
	<label for="end_date" class="col-xs-3 col-form-label">End Date <span class="asteroid">*</span></label>
	<div class="col-xs-3">
	  <%= f.text_field :end_date, :readonly => true, :class => 'form-control' %>
	</div>
  </div>
  
  <div class="form-group">
  	<%= f.check_box :coming_soon %><span>&nbsp;&nbsp;Would you like your event guide to be listed as "Coming Soon"? Event guides listed as "Coming Soon" appear in the Eventbase app but cannot be downloaded while this option is selected.</span>
  </div>

  <hr>

  <div class="form-group"><h3>Event Location</h3></div>

  <div class="address">
	  <div class="form-group row">
		<label for="address" class="col-xs-3 col-form-label">Address <span class="asteroid">*</span></label>
		<div class="row col-xs-6">
		  <div class="col-xs-10">
		  	<input id="event_address" name="event[address]" type="text" placeholder="Type in an address" value="111 Broadway, New York, NY" class="form-control" />	
		  </div>
		  
		  <div class="col-xs-2">
		  	<input id="find" type="button" value="Find" class="btn btn-primary" />
		  </div>     
		</div>
	  </div>

	  <div class="map_canvas"></div>

	  <div class="form-group row">
		<label for="lat" class="col-xs-3 col-form-label">Latitude</label>
		<div class="col-xs-3">
		  <input id="lat" name="lat" type="text" value="" class="form-control" disabled="disabled">
		  <input type="hidden" name="event[lat]" id="event_lat">
		</div>
	  </div>

	  <div class="form-group row">
		<label for="lng" class="col-xs-3 col-form-label">Longitude</label>
		<div class="col-xs-3">
		  <input id="lng" name="lng" type="text" value="" class="form-control" disabled="disabled">
		  <input type="hidden" name="event[lng]" id="event_lng">
		</div>
	  </div>

	  <div class="form-group row">
		<label class="col-xs-3 col-form-label">Formatted Address</label>
		<div class="col-xs-3">
		  <input name="formatted_address" type="text" value="" class="form-control" disabled="disabled">	  
		</div>
		<div class="col-xs-6">
			<a id="reset" href="#" style="display:none;">Reset Marker</a>
		</div>
	  </div>
  </div>

  <hr>

  <div class="form-group">
  	<input type="checkbox" id="extra"><span>&nbsp;&nbsp;Do you need any more fields?</span>
  </div>

  <div class="extra" style="display:none;">
	  <div class="form-group row">
		<label for="extra_name" class="col-xs-3 col-form-label">Extra Field Name <span class="asteroid">*</span></label>
		<div class="col-xs-6">
		  <%= f.text_field :extra_name, :class => 'form-control' %>
		</div>
	  </div>

	  <div class="form-group row">
		<label for="extra_desc" class="col-xs-3 col-form-label">Description <span class="asteroid">*</span></label>
		<div class="col-xs-6">
		  <%= f.text_area :extra_desc, :class => 'form-control', :rows => 7 %>
		</div>
	  </div>

	  <div class="form-group row">
	  	<div class="col-xs-3">
	  		<input id="event_extra_date_first_name" name="event[extra_date_first_name]" type="text" placeholder="Type first extra date field name" class="form-control" />
	  	</div>
	  	<div class="col-xs-3">
		  <%= f.text_field :extra_date_first, :class => 'form-control' %>
		</div>
	  </div>

	  <div class="form-group row">
	  	<div class="col-xs-3">
	  		<input id="event_extra_date_second_name" name="event[extra_date_second_name]" type="text" placeholder="Type second extra date field name" class="form-control" />
	  	</div>
	  	<div class="col-xs-3">
		  <%= f.text_field :extra_date_second, :class => 'form-control' %>
		</div>
	  </div>		
  </div>
  <hr>

  <%= f.submit "Save New Event", :class => 'btn btn-primary' %>
  
  <%= link_to 'Back', events_path, :class => 'btn btn-warning' %>
<% end %>


<script>
	$(document).ready(function(){
		$('#event_timezone').timezones();
		$('#event_start_date').datepicker({
			dateFormat: 'yy-mm-dd'
		});
		$('#event_end_date').datepicker({
			dateFormat: 'yy-mm-dd'
		});
		$('#event_extra_date_first').datepicker({
			dateFormat: 'yy-mm-dd'
		});
		$('#event_extra_date_second').datepicker({
			dateFormat: 'yy-mm-dd'
		});
		
		$("#event_address").geocomplete({
	      map: ".map_canvas",
	      details: ".address",
	      markerOptions: {
	        draggable: true
	      }
	    });
	    
	    $("#event_address").on("geocode:dragged", function(event, latLng){
	      $("input[name=lat]").val(latLng.lat());
	      $("input[name=lng]").val(latLng.lng());
	      $("#reset").show();
	    });

	    $("#event_address").on("change", function(){
	    	$("#find").trigger("click");	
	    });
	    

	    $("#reset").click(function(){
	      $("#event_address").geocomplete("resetMarker");
	      $("#reset").hide();
	      return false;
	    });
	    
	    $("#find").click(function(){
	      $("#event_address").trigger("geocode");
	    }).click();	

	    $("#extra").on('click', function(){
	    	if($(this).prop('checked') == true) 
	    		$('.extra').css('display', 'initial');
	    	else
	    		$('.extra').css('display', 'none');
	    });

	    $.validator.setDefaults({
			submitHandler: function() {
				$('#event_lat').val($('#lat').val());
				$('#event_lng').val($('#lng').val());
				document.getElementById("new_event_form").submit()
			}
		});

		var rules = function () {
			var rules = {
				'event[name]': "required",
				'event[description]': "required",
				'event[start_date]': "required",
				'event[end_date]': "required",
				'event[address]': "required"	
			}

			// if($('#extra').prop('checked')) {
			// 	rules['event[extra_name]'] = "required";
			// 	rules['event[extra_desc]'] = "required";

			// 	if($('#event_extra_date_first').val() || $('#event_extra_date_first_name').val()) {
			// 		rules['event[extra_date_first_name]'] = "required";	
			// 		rules['event[extra_date_first]'] = "required";
			// 	}

			// 	if($('#event_extra_date_second').val() || $('#event_extra_date_second_name').val()) {
			// 		rules['event[extra_date_second_name]'] = "required";	
			// 		rules['event[extra_date_second]'] = "required";
			// 	}
			// }

			return rules;
		}

	    $("#new_event_form").validate({
			rules: rules(),
			messages: {
				'event[name]': "Please enter an event name",
				'event[description]': "Please enter a description",
				'event[start_date]': "Please select start date",
				'event[end_date]': "Please select end date",
				// 'event[address]': "Please point a event address",
				// 'event[extra_name]': "Please enter an extra field name",
				// 'event[extra_desc]': "Please enter an extra field description",
				// 'event[extra_date_first_name]': "Please enter the first extra date name",
				// 'event[extra_date_first]': "Please select the first extra date",
				// 'event[extra_date_second_name]': "Please enter the second extra date name",
				// 'event[extra_date_second]': "Please select the second extra date"		
			}
		});

		$("#extra").on('click', function(){
			if($(this).prop('checked')) {
				$("#event_extra_name").rules( "add", {
				  required: true,
				  messages: {
				    required: "Please enter an extra field name"
				  }
				});

				$("#event_extra_desc").rules( "add", {
				  required: true,
				  messages: {
				    required: "Please enter an extra field description"
				  }
				});	
			} else {
				$("#event_extra_name").rules( "remove" );
				$("#event_extra_desc").rules( "remove" );
			}
		});

	    $(".extra input[type='text']").on('change', function() {

			if($('#event_extra_date_first').val() || $('#event_extra_date_first_name').val()) {
				$("#event_extra_date_first_name").rules( "add", {
				  required: true,
				  messages: {
				    required: "Please enter the first extra date name"
				  }
				});	

				$("#event_extra_date_first").rules( "add", {
				  required: true,
				  messages: {
				    required: "Please select the first extra date"
				  }
				});

			} else {
				$("#event_extra_date_first_name").rules("remove");
				$("#event_extra_date_first").rules("remove");
			}

			if($('#event_extra_date_second').val() || $('#event_extra_date_second_name').val()) {
				$("#event_extra_date_second_name").rules( "add", {
				  required: true,
				  messages: {
				    required: "Please enter the second extra date name"
				  }
				});	

				$("#event_extra_date_second").rules( "add", {
				  required: true,
				  messages: {
				    required: "Please select the second extra date"
				  }
				});

			} else {
				$("#event_extra_date_second_name").rules("remove");
				$("#event_extra_date_second").rules("remove");
			}
	    }); 

	});
	
</script>


